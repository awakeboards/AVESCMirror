#ifndef _AW_THROTTLE_H
#define _AW_THROTTLE_H

#include <math.h>

#include "app.h"
#include "ch.h"
#include "hal.h"

#include "mc_interface.h"
#include "mcpwm_foc.h"

#include "comm_can.h"
#include "hw.h"
#include "timeout.h"

#include "aw_datatypes.h"

#define AW_STARTUP_CURRENT_INITIAL      20      // A - initial current when the motor startup happens
#define AW_STARTUP_CURRENT_MAX          80      // A - maximal current when the motor startup happens
#define AW_STARTUP_CURRENT_RAMP         20      // A/s - how fast to increase startup current
#define AW_STARTUP_TIMEOUT              5       // s - max time of startup before we consider the motor stuck
#define AW_MIN_STABLE_RPM               2000    // eRPM - eRPM where the motor is considered started up

#define AW_RAVIK_MIN_ACTIVE_CURRENT     5       // A - minimal current during a normal motor operation
#define AW_VINGA_MIN_ACTIVE_CURRENT     10      // A - minimal current during a normal motor operation

#define AW_BRABUS_CURRENT_BOOST         1.2     // boost the current by this factor when in Brabus mode
#define AW_BRABUS_CURRENT_IN_BOOST      1.2     // boost the current by this factor when in Brabus mode

static const float aw_curve_vinga_extreme[] = {0, 0.007323,0.016297,0.025797,0.035754,0.046107,0.056796,0.067762,0.078951,0.090312,0.1018,0.11336,0.12495,0.13654,0.14808,0.15954,0.17089,0.18209,0.19312,0.20396,0.21456,0.22493,0.23503,0.24485,0.25438,0.2636,0.27251,0.28108,0.28933,0.29723,0.3048,0.31202,0.31889,0.32543,0.33164,0.33751,0.34305,0.34829,0.35321,0.35785,0.3622,0.36628,0.37011,0.37371,0.37709,0.38027,0.38327,0.38611,0.38881,0.3914,0.3939,0.39634,0.39874,0.40112,0.40351,0.40595,0.40845,0.41106,0.41378,0.41667,0.41974,0.42302,0.42656,0.43037,0.43449,0.43895,0.44379,0.44902,0.4547,0.46084,0.46748,0.47465,0.48238,0.4907,0.49965,0.50925,0.51954,0.53054,0.54229,0.55481,0.56812,0.58227,0.59728,0.61317,0.62996,0.64769,0.66638,0.68605,0.70672,0.72842,0.75116,0.77497,0.79987,0.82586,0.85297,0.88122,0.91061,0.94115,0.97287,1};
static const float aw_curve_vinga_sport[] =   {0, 0.0085226,0.012497,0.017371,0.023047,0.029428,0.036426,0.043957,0.051939,0.060298,0.068961,0.077862,0.086939,0.096132,0.10539,0.11465,0.12389,0.13304,0.14208,0.15096,0.15966,0.16814,0.17639,0.18437,0.19207,0.19948,0.20658,0.21335,0.2198,0.22592,0.2317,0.23714,0.24226,0.24704,0.25151,0.25567,0.25952,0.26309,0.26639,0.26943,0.27223,0.27482,0.27721,0.27943,0.2815,0.28345,0.28529,0.28707,0.2888,0.29052,0.29226,0.29404,0.2959,0.29787,0.29997,0.30225,0.30473,0.30745,0.31043,0.31372,0.31733,0.32131,0.32568,0.33048,0.33573,0.34146,0.34771,0.35449,0.36185,0.36979,0.37835,0.38755,0.39741,0.40795,0.41919,0.43116,0.44386,0.4573,0.47151,0.48648,0.50224,0.51878,0.53611,0.55423,0.57314,0.59283,0.6133,0.63454,0.65654,0.67928,0.70275,0.72692,0.75178,0.77729,0.80342,0.83014,0.85742,0.8852,0.91345,0.94212};
static const float aw_curve_vinga_eco[] =     {0, 0.0065983,0.0096094,0.013,0.016724,0.020741,0.025011,0.029496,0.034161,0.038973,0.0439,0.048914,0.053988,0.059097,0.064218,0.06933,0.074414,0.079453,0.084431,0.089333,0.094149,0.098868,0.10348,0.10798,0.11236,0.11661,0.12074,0.12474,0.12861,0.13235,0.13596,0.13946,0.14283,0.1461,0.14926,0.15232,0.15529,0.15819,0.16101,0.16378,0.1665,0.16919,0.17186,0.17453,0.17721,0.17991,0.18266,0.18547,0.18835,0.19132,0.19441,0.19762,0.20098,0.2045,0.20821,0.21212,0.21626,0.22063,0.22526,0.23017,0.23537,0.24089,0.24675,0.25295,0.25953,0.26649,0.27385,0.28164,0.28986,0.29854,0.30768,0.31731,0.32743,0.33806,0.34922,0.36091,0.37315,0.38594,0.3993,0.41323,0.42774,0.44284,0.45853,0.47482,0.49171,0.5092,0.52729,0.54598,0.56528,0.58516,0.60564,0.6267,0.64834,0.67055,0.69331,0.71661,0.74044,0.76478,0.78962,0.81493};
static const float aw_curve_vinga_kids[] =    {0, 0.00063554,0.0024433,0.0044749,0.0066951,0.0090714,0.011574,0.014174,0.016848,0.019571,0.022323,0.025085,0.027839,0.03057,0.033265,0.035911,0.038499,0.04102,0.043465,0.04583,0.04811,0.0503,0.052398,0.054404,0.056315,0.058134,0.059861,0.061498,0.063048,0.064514,0.065901,0.067213,0.068454,0.069631,0.07075,0.071816,0.072835,0.073815,0.074763,0.075685,0.076588,0.077479,0.078366,0.079256,0.080156,0.081072,0.082012,0.082983,0.08399,0.08504,0.08614,0.087295,0.088511,0.089793,0.091146,0.092574,0.094083,0.095676,0.097356,0.099128,0.10099,0.10296,0.10502,0.10718,0.10944,0.11181,0.11428,0.11685,0.11952,0.1223,0.12519,0.12817,0.13125,0.13443,0.13771,0.14108,0.14454,0.14809,0.15172,0.15544,0.15924,0.16311,0.16705,0.17106,0.17514,0.17928,0.18348,0.18773,0.19203,0.19638,0.20078,0.20522,0.2097,0.21423,0.21879,0.22338,0.22802,0.23269,0.2374,0.24215};

static const float aw_curve_ravik_brabus[] =   {0,0.010835,0.025348,0.039696,0.053855,0.067803,0.081522,0.094992,0.1082,0.12112,0.13376,0.14609,0.15811,0.1698,0.18117,0.1922,0.20289,0.21324,0.22325,0.23291,0.24223,0.25121,0.25986,0.26817,0.27615,0.28381,0.29115,0.29819,0.30494,0.31139,0.31758,0.3235,0.32917,0.3346,0.33981,0.34481,0.34961,0.35424,0.35871,0.36304,0.36723,0.37132,0.37532,0.37924,0.38311,0.38695,0.39077,0.39459,0.39844,0.40233,0.40629,0.41032,0.41446,0.41873,0.42313,0.4277,0.43245,0.43739,0.44256,0.44797,0.45363,0.45957,0.4658,0.47234,0.47921,0.48642,0.49399,0.50193,0.51026,0.519,0.52815,0.53772,0.54774,0.55821,0.56914,0.58054,0.59242,0.60478,0.61764,0.63099,0.64485,0.65921,0.67408,0.68945,0.70533,0.72172,0.73861,0.756,0.77388,0.79224,0.81108,0.83039,0.85015,0.87036,0.89099,0.91203,0.93346,0.95526,0.97741,1};
static const float aw_curve_ravik_extreme[] =  {0, 0.011167,0.029407,0.047437,0.065232,0.082769,0.10003,0.11699,0.13363,0.14995,0.16592,0.18154,0.1968,0.21168,0.22619,0.24032,0.25406,0.26742,0.28039,0.29298,0.30518,0.31701,0.32847,0.33956,0.35029,0.36067,0.37072,0.38043,0.38982,0.39891,0.40771,0.41622,0.42447,0.43247,0.44024,0.44778,0.45513,0.46229,0.46927,0.47611,0.48282,0.48941,0.4959,0.50231,0.50865,0.51496,0.52123,0.5275,0.53378,0.54008,0.54642,0.55282,0.5593,0.56586,0.57253,0.57931,0.58623,0.59329,0.60051,0.60789,0.61545,0.6232,0.63114,0.63929,0.64764,0.6562,0.66499,0.67399,0.68321,0.69265,0.7023,0.71217,0.72225,0.73253,0.74301,0.75367,0.76451,0.7755,0.78663,0.79789,0.80926,0.82072,0.83223,0.84378,0.85534,0.86687,0.87835,0.88973,0.90099,0.91208,0.92296,0.93358,0.9439,0.95386,0.96342,0.97251,0.98107,0.98905,0.99638,1};
static const float aw_curve_ravik_sport[] =    {0, 0.0087103,0.022938,0.037001,0.050881,0.06456,0.078021,0.091249,0.10423,0.11696,0.12942,0.1416,0.1535,0.16511,0.17643,0.18745,0.19817,0.20859,0.2187,0.22852,0.23804,0.24727,0.25621,0.26486,0.27323,0.28133,0.28916,0.29673,0.30406,0.31115,0.31801,0.32465,0.33109,0.33733,0.34339,0.34927,0.355,0.36058,0.36603,0.37137,0.3766,0.38174,0.3868,0.3918,0.39675,0.40167,0.40656,0.41145,0.41635,0.42126,0.42621,0.4312,0.43625,0.44137,0.44657,0.45186,0.45726,0.46277,0.4684,0.47415,0.48005,0.4861,0.49229,0.49864,0.50516,0.51184,0.51869,0.52571,0.5329,0.54026,0.5478,0.55549,0.56336,0.57138,0.57955,0.58786,0.59631,0.60489,0.61357,0.62236,0.63122,0.64016,0.64914,0.65815,0.66716,0.67616,0.68511,0.69399,0.70277,0.71142,0.71991,0.7282,0.73624,0.74401,0.75147,0.75856,0.76524,0.77146,0.77718,0.78};
static const float aw_curve_ravik_eco[] =      {0, 0.0071469,0.018821,0.03036,0.041748,0.052972,0.064017,0.074871,0.085524,0.095966,0.10619,0.11619,0.12595,0.13548,0.14476,0.1538,0.1626,0.17115,0.17945,0.18751,0.19532,0.20289,0.21022,0.21732,0.22419,0.23083,0.23726,0.24347,0.24949,0.2553,0.26093,0.26638,0.27166,0.27678,0.28175,0.28658,0.29128,0.29586,0.30034,0.30471,0.309,0.31322,0.31737,0.32148,0.32554,0.32957,0.33359,0.3376,0.34162,0.34565,0.34971,0.35381,0.35795,0.36215,0.36642,0.37076,0.37519,0.37971,0.38432,0.38905,0.39389,0.39885,0.40393,0.40914,0.41449,0.41997,0.42559,0.43135,0.43725,0.44329,0.44947,0.45579,0.46224,0.46882,0.47553,0.48235,0.48928,0.49632,0.50345,0.51065,0.51793,0.52526,0.53263,0.54002,0.54741,0.5548,0.56214,0.56943,0.57664,0.58373,0.5907,0.59749,0.6041,0.61047,0.61659,0.62241,0.62789,0.63299,0.63768,0.64};
static const float aw_curve_ravik_kids[] =     {0, 0.0023451,0.0061755,0.0099618,0.013699,0.017381,0.021006,0.024567,0.028063,0.031489,0.034843,0.038123,0.041327,0.044453,0.0475,0.050467,0.053353,0.056158,0.058882,0.061525,0.064088,0.066572,0.068978,0.071307,0.073561,0.075742,0.07785,0.07989,0.081863,0.083772,0.085618,0.087407,0.089139,0.090819,0.09245,0.094035,0.095577,0.09708,0.098548,0.099984,0.10139,0.10278,0.10414,0.10548,0.10682,0.10814,0.10946,0.11078,0.11209,0.11342,0.11475,0.11609,0.11745,0.11883,0.12023,0.12166,0.12311,0.12459,0.12611,0.12766,0.12924,0.13087,0.13254,0.13425,0.136,0.1378,0.13965,0.14154,0.14347,0.14546,0.14748,0.14956,0.15167,0.15383,0.15603,0.15827,0.16055,0.16285,0.16519,0.16756,0.16995,0.17235,0.17477,0.17719,0.17962,0.18204,0.18445,0.18684,0.18921,0.19154,0.19382,0.19605,0.19822,0.20031,0.20232,0.20423,0.20603,0.2077,0.20924,0.21};

void aw_init_throttle(void);

void aw_handle_throttle(uint8_t throttle, uint8_t mode);

#endif
